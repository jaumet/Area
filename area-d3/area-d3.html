<!DOCTYPE html>
<html>
  <head>
    <title>Hello, data!</title>
    <script type="text/javascript" src="js/jquery.js"></script>
	<script type="text/javascript" src="js/d3.v2.js"></script>
	<!--<script type="text/javascript" src="js/underscore-min.js"></script>-->
	<script type="text/javascript" src="js/area_functions.js"></script>
	<script type="text/javascript" src="data.json"></script>

	<style>
		#area {	position:relative;float:left;border-top: 0px solid grey;}
		#good td { border: 1px solid green;}
		#bad td { border: 1px solid red;}
		.node { position:relative;float:left;}
		.block {position:relative;float:left;border-right: 1px solid black;border-bottom: 0px solid grey;}
		.blockname {padding-left:6px;border-bottom: 1px solid grey;border-top: 1px solid grey;}
	</style>
  </head>
  <body>
   	<div id="analysis">
   		<p>GOOD:</p>
   		<table id="good"></table>
   		<p>BAD:</p>
   		<table id="bad"></table>
   	</div>
   	<div style="clear:both;"></div>
    <p>display</p>
    <div id="area">
	</div>

    <script type="text/javascript">
    	
		////////////////////////////////
		// AREA CONFIG
		var MAX_DISTINC = 10;
		var AREAX = 900;
		var AREAY = 500;
		var COLORS_APPROACH = "gradient"; // fix, random, gradient
		var PARAM1 = "mood";
		var PARAM2 = "name";
		
		////////////////////////////////
		// DATA PARSER:
		var d_length = data.length;

		// Get list of parameters from data:
		var params = [];
		var dupes = {};
		$.each(data, function(i0, el0) {
			$.each(el0, function(i, el) {
				//console.log("i0 :"+i0+" | el0: "+el0+" | i: "+i+" | el : "+el);
				if (!dupes[i]) {
					dupes[i] = true;
					params.push(i);
				}
			});
		});
		
		// Walk through the list of parameters and draw a table
		var d = [];
		var l = 0;
		$.each(params, function(i, el) {
			d = distinc(data, el);
			l = d.length;
			if (l<MAX_DISTINC) {myid = "#good";} else {myid = "#bad";}
			$(myid).append(
				'<tr><td>'+el+'</td><td>'+l+'</td><td>'+d+'</td></tr>'
			);
		});
		
		// Count here the max number of elements for each value and get the max one
		max1 = 0;max1name = '';
		distinc1 = distinc(data, PARAM1);
		console.log("distinc1: "+distinc1);
		$.each(distinc1, function(i, el) {
			if (countValues(data, PARAM1, el) > max1) {
				max1 = countValues(data, PARAM1, el);
				max1name = el;
			}
		});
			
		//////////////////////////////////////////
		// DISPLAY
		
		///////////////////////
		// BLOCK REPRESENTATION

		function block_builder(data, blockx, blocky, param_val1, param2colors, areaSVG) {
			//var b_container = 300; // this is block dimenssion
			var dim_node = Math.sqrt(max1);
			if (dim_node != Math.floor(dim_node)) {
				dim_node = Math.floor(dim_node)+1;
			}
			var nodex = Math.floor(blockx/dim_node);
			var nodey = Math.floor(blocky/dim_node);
				
			// creating a d3 canvas per block
			areaSVG = d3.select('#b-'+param_val1)
				.append("svg:svg")
				.attr("width", blockx)
				.attr("height", blocky)
				.style('position','relative');
			
			var my_x = 0;
			var my_y = 0;
			var count = 0;
			$.each(data, function(index, value) {
				var content = "<ul>";
				if(value[PARAM1] == param_val1) {
					n = count/dim_node;
					if (typeof n === 'number' && n % 1 == 0) {
						my_x = 0;
					} else {
						my_x = my_x + nodex;
					}
					// build node content:
					$.each(value, function(i, el) {
						content += "<li>"+el+"</li>";
					});
					content += "</ul>";
					my_y = Math.floor(n) * nodey;
					draw_node(my_x, my_y, nodex, nodey, value.id, content, param2colors[value[PARAM2]], areaSVG);
					count ++;
					content = "";
				}
			});
		}
		
		function draw_node(x, y, nodex, nodey, id, content, color, areaSVG) {	
			areaSVG.append("svg:rect")
				.attr("x", x)
				.attr("y", y)
				.attr("width", nodex)
				.attr("height", nodey)
				.attr("stroke", "#ffffff")
				.attr('class','node')
				.attr("id", id)
				.style('fill',color)
				.on('mouseover', function(d,i) { 
		    		d3.select(this)
		      			.style('fill','lightblue'); 
		   		})
				.on('mouseout', function(d,i) { 
        			d3.select(this)
    					.style('fill',color); 
      			})
      			.on('click', function(d,i) {
	      			d3.select(this)
  	    			alert(content);
      		});
		};
		
		///////////////////////
		// MATRIX REPRESENTATION
		
		///////////
		// Prepare colors for PARAM2 values:
		
		// PARAM2's colors 
		var param2colors = [];
		var distinc2 = distinc(data, PARAM2).sort();
		switch(COLORS_APPROACH) {
			case "fix":
				// Approach 1: fix list and order of colors
				var colors = ['#CC5151', '#51CCCC', '#8ECC51', '#8E51CC', '#CCAD51', '#51CC70', '#5170CC', '#CC51AD', '#CC7F51', '#BCCC51', '#60CC51', '#51CC9E', '#519ECC', '#6051CC', '#BC51CC', '#CC517F', '#CC6851', '#CC9651', ];
				//var colors_dark = ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ];			  
			  break;
			case "random":
				colors = get_random_colors(distinc2.length);
			  break;
			case "gradient":
				colors = get_random_hsv(60, 100, distinc2.length);
			  break;
			//default:
			//  default code here 
		}
		
		$.each(distinc2, function(i, el) {
			param2colors[el] = colors[i];
		});

		/////////
		// order/sort & sizes
		sortJSON(data,PARAM2);
			
		// Order of blocks by PARAM1: use .sort() OR .reverse()
		distinc1 = distinc(data, PARAM1).sort(); // ASC
		//distinc1 = distinc(data, PARAM1);//.reverse(); // DESC (to use it just uncomment this line and let the sort() one active

		// Get size of area:
		// Number of blocks: distinc1.length
		var dim_blocks = Math.sqrt(distinc1.length);
		if (dim_blocks != Math.floor(dim_blocks)) {
			dim_blocks = Math.floor(dim_blocks)+1;
		}
		var blockx = Math.floor(AREAX/dim_blocks);
		var blocky = Math.floor(AREAY/dim_blocks);
		$('#area').css("width", AREAX+2+(2*dim_blocks)+"px"); // FIXME check this width correction 
		$.each(distinc1, function(i, param1_val) {
			$('#area').append('<div id="b-'+param1_val+'" class="block"><div class="blockname">'+param1_val+'</div></div>');
			block_builder(data, blockx, blocky, param1_val, param2colors);
		});

    </script>
  </body>
</html>


<!DOCTYPE html>
<html>
  <head>
    <title>Hello, data!</title>
    <script type="text/javascript" src="js/jquery.js"></script>
	<script type="text/javascript" src="js/d3.v2.js"></script>
	<!--<script type="text/javascript" src="js/underscore-min.js"></script>-->
	<script type="text/javascript" src="data.json"></script>

	<style>
		.node { position:relative;float:left;} /*fill:grey;}*/
		#area {	position:relative;float:left;border: 2px solid blue;height:3px;}
		#good td { border: 1px solid green;}
		#bad td { border: 1px solid red;}
		.block {position:relative;float:left;}
		.blockname, .block {border: 1px solid green;}
	</style>
  </head>
  <body>
   	<div id="analysis">
   		<p>GOOD:</p>
   		<table id="good"></table>
   		<p>BAD:</p>
   		<table id="bad"></table>
   	</div>
   	<div style="clear:both;"></div>
    <p>display</p>
    <div id="area">
	</div>

    <script type="text/javascript">
    	
		////////////////////////////////
		// AREA CONFIG
		var MAX_DISTINC = 10;
		
		////////////////////////////////
		// DATA PARSER:
		var d_length = data.length;
		
	    // Function to get distinc values for a parameter:
	    function distinc(data, param) {
			var dupes = {};	
			var singles = [];
			$.each(data, function(i, el) {
			if (!dupes[el[param]]) {
					dupes[el[param]] = true;
					singles.push(el[param]);
				}
			});
			return singles;
		}

		// Get list of parameters from data:
		var params = [];
		var dupes = {};
		$.each(data, function(i0, el0) {
			$.each(el0, function(i, el) {
				if (!dupes[i]) {
					dupes[i] = true;
					params.push(i);
				}
			});
		});
		
		// Walk through the list of parameters and draw a table
		var d = [];
		var l = 0;
		$.each(params, function(i, el) {
			d = distinc(data, el);
			l = d.length;
			//alert("llll :"+l);
			if (l<MAX_DISTINC) {myid = "#good";} else {myid = "#bad";}
			$(myid).append(
				'<tr><td>'+el+'</td><td>'+l+'</td><td>'+d+'</td></tr>'
			);
			//console.log(el+" -> "+distinc(data, el));
		});

		//////////////////////////////////////////
		// DISPLAY
		
		///////////////////////
		// BLOCK REPRESENTATION
		
		function block_builder(data, param_val1, block_div, areaSVG) {
			var b_container = 300; // this is block dimenssion
			//c_node = 78;
			var dim_node = Math.sqrt(d_length);
			if (dim_node != Math.floor(dim_node)) {
				dim_node = Math.floor(dim_node)+1;
			}
			var c_node = Math.floor(b_container/dim_node);
			//alert("dims :"+dim_node+" | "+c_node);

			areaSVG = d3.select(block_div)
				.append("svg:svg")
				.attr("width", b_container)
				.attr("height", b_container)
				.style('position','relative');

			// Colors for param2
			var colors = ['#cc3333', '#7f33cc', '#7fcc33','#33cccc'];
			
			// Assign colors to param2 values:
			// FIXME colors must be assigned only once for each area (=> outside of the block_builder function)
			var param2colors = [];
			$.each(distinc(data, param2), function(i, el) {
				param2colors[el] = colors[i];
			});
			//console.log(param2);
			//console.log(param2colors);
			
			// FIXME Order data by param2 values:
			//data(function):
			/*
			function sortBy(fields) {
				return function (a, b) {
					var A;
					var B;
					for( var i=0 ; i< fields.length ; i++ ) {
						A += a[fields[i]];
						B += b[fields[i]];
					}
					return A == B ? 0 : (A < B ? -1 : 1)
				};
			}
			data = data.sort(sortBy(2, 2));
			*/
			console.log(data);

			// 
			var my_x = 0;
			var my_y = 0;
			var count = 0;
			$.each(data, function(index, value) {
				if(value[param1] == param_val1) {
					n = count/dim_node;
					if (typeof n === 'number' && n % 1 == 0) {
						my_x = 0;
					} else {
						my_x = my_x + c_node;
					}
					my_y = Math.floor(n) * c_node;
					draw_node(my_x, my_y, c_node, value.id, value.name, param2colors[value[param2]], areaSVG);
					count = count +1;
				}
			});
		}
		
		function draw_node(x, y, c_node, id, name, color, areaSVG) {	
			areaSVG.append("svg:rect")
				.attr("x", x)
				.attr("y", y)
				.attr("width", c_node)
				.attr("height", c_node)
				.attr("stroke", "red")
				.attr('class','node')
				.attr("id", id)
				.attr("name", name)
				.style('fill',color)
				.on('mouseover', function(d,i) { 
		    		d3.select(this)
		      			.style('fill','lightblue'); 
		   		})
				.on('mouseout', function(d,i) { 
        			d3.select(this)
    					.style('fill',color); 
      			})
      			.on('click', function(d,i) {
	      			d3.select(this)
  	    			alert("id: "+id+" | name: "+name);
      		});
		};
		
		// Area builder (matrix of blocks):
		// List of params and params values
		var param1 = "gender";
		var param2 = "mood";
		
		// 
		$.each(distinc(data, param1), function(i, param1_val) {
			$('#area').append('<div id="b-'+param1_val+'" class="block"><div class="blockname">'+param1_val+'</div></div>');
			block_builder(data, param1_val, '#b-'+param1_val);
		});

    </script>

  </body>
</html>


<!DOCTYPE html>
<html>
  <head>
    <title>AREA</title>
    <script type="text/javascript" src="js/jquery.js"></script>
	<script type="text/javascript" src="js/d3.v2.js"></script>
	<script type="text/javascript" src="area-config.js"></script>

	<style>
		#area {	position:relative;float:left;border-top: 0px solid grey;}
		thead {background-color:#ffffff;}
		#good, #bad { border: 1px solid #ffffff;}
		.node { position:relative;float:left;}
		.block {position:relative;float:left;border-right: 1px solid black;border-bottom: 0px solid grey;}
		.blockname {padding-left:6px;border-bottom: 1px solid grey;border-top: 1px solid grey;}
		#expand {
			position:relative;float:top;background-image:url('images/expand.png');background-repeat:no-repeat;background-position:center;
		}
		#title, #config {position:relative;float:left;height:45px;border:0px solid red;}
		.tab {height:120px;border:0px solid red;overflow:auto;background-color:#EBEBEB;padding-left:7px;border:0px solid #000000;}
		.tabs li {
				list-style:none;
				display:inline;
			}

			.tabs a {
				padding:5px 10px;
				display:inline-block;
				background:#666;
				color:#fff;
				text-decoration:none;
			}

			.tabs a.active {
				background:#EBEBEB;
				color:#000;
				border-bottom: 1px solid #C1C1C1;
			}
			.defaultText { width: 40px; }
			.configuration_div {
				position:relative;
				float:left;
				min-width:240px;
			}
			.legendlist {
				line-height:30px;	
			}
			.legendlist span {
				border:1px solid #000000;
				padding:3px;
			}
			#node_infoXX {
				position:absolute;
				left:40px;
				top:200px;
				border:2px solid green;
				min-width:300px;
				min-height:300px;
				z-index:20;
			}
			select, input{font-size:20px;}
			input, select{background-color:#FFC29C;}
			#filter { width: 100px; }
	</style>
  </head>
  <body>
  	<div id="panel">
		<div id="title">
			<p syle="padding:0;margin:0;">AREA: explore data at a glance</p>
		</div>
		<div id="config">
			<ul class='tabs'>
				<li><a href='#tab1'>Parameters & legend</a></li>
				<li><a href='#tab2'>filter</a></li>
				<li><a href='#tab3'>About the data</a></li>
				<li><a href='#tab4'>Configuration</a></li>
			</ul>
		</div>
		<div style="clear:both;"></div>
		<div id='tab1' class="tab">
			<div class="configuration_div">
				<p>Parameters</p>
				<div id="params">
				</div>
				<input type="button" class="submit_params" value="apply" />
			</div>
			<div class="configuration_div">
				<p>Legend</p>
				<p>
					Blocks:&nbsp;&nbsp;<span id="legend1" class="legendlist"></span>
					<br />
					Colors:&nbsp;&nbsp;<span id="legend2" class="legendlist"></span>
				</p>
			</div>			
		</div>
		<div id='tab2' class="tab">
			<p>
				<div id="filtered_params"></div>
				<input id="filter" type="text" />
				<input type="button" class="submit_params" value="filter" />
			</p>
		</div>
		<div id='tab3' class="tab">
			<div id="analysis">
				<span>Eligible parameters:</span>
				<table id="good"></table>
				<p>&nbsp;</p>
				<span>Rest of parameters:</span>
				<table id="bad"></table>
			</div>
		</div>
		<div id='tab4' class="tab">
			<div class="configuration_div">
				<p>size: 
					<input class="defaultText" id="areax" type="text" />
					&nbsp;<b>X</b>&nbsp;
					<input class="defaultText" id="areay" type="text" />
				</p>
				<p>colors schema: 
					<select id="colors_approach">
						<option value="fix">fix</option>
						<option value="random">random</option>
						<option value="gradient">gradient</option>
					</select>				
				</p>
			</div>
			<div class="configuration_div">
				<p>
					<input type="button" class="submit_params" value="apply" />
				</p>
			</div>
		</div>
	</div>

   	<div style="clear:both;height:20px;"></div>
	<div>
	    <div id="area">
		</div>
		<div id="node_info">NODE INFO</div>
	</div>
	
	<script type="text/javascript" src="js/area_functions.js"></script>
    <script type="text/javascript">
		
		///////////////////////////////
		// MAIN AREA FUNCTION
		function do_area(PARAM1, PARAM2, AREAX, AREAY, COLORS_APPROACH, FILTER) {
			
			////////////////////////////////
			// FILTER TAB
			
			// FIXME needs to be passed the array or string of filter checkboxes. 
			//Then build an array with checked ones and coadd it yo ths IF statatement on line 266
			
			var filter_params_list = 'Check parameters to filter:<br />';
			$.each(FIELDS[0], function(i, el) {
				if (el.filter == 1) {
					filter_params_list += '<input type="checkbox" checked value="'+i+'">'+el.human+'&nbsp;&nbsp;';	
				}
			});			
			$('#filtered_params').append(filter_params_list);
			
			////////////////////////////////
			// DATA PARSER:
			var d_length = DATA.length;
	
			// Get list of parameters from DATA:
			var params = [];
			var dupes = {};
			var rows = 0;
			$.each(DATA, function(i0, el0) {
				rows ++;
				$.each(el0, function(i, el) {
					if (!dupes[i]) {
						dupes[i] = true;
						params.push(i);
					}
				});
			});
			// 
			$('#analysis').prepend('<div id="expand">&nbsp;</div><p>number of cases: <b>'+rows+'</b></p>');			
			var thead = '<thead><tr><th>Name</th><th>Number of values</th><th>Values</th></tr></thead>';
			$('#good').append(thead);	
			$('#bad').append(thead);

			// Walk through the list of parameters and draw a table, and the the dropdowns for the two parameters
			var d = [];
			var l = 0;
			var myoptions_end = ''; var myopt='';
			myoptions1 = '<select id="options1"><option value="select">select</option>';
			myoptions2 = '<select id="options2"><option value="select">select</option>';
			$.each(params, function(i, el) {
				d = distinc(DATA, el);
				l = d.length;
				if (l<MAX_DISTINC) {
					myid = "#good";
					myopt += '<option value='+el+'>'+el+'</option>';
				} else {
					myid = "#bad";
				}
				$(myid).append(
					'<tr><td>'+el+'</td><td>'+l+'</td><td>'+d+'</td></tr>'
				);
			});
			myoptions_end += '</select>';
			dbarrow = '<img id="dbarrow" src="images/dbarrow.png" width="30px" />';
			$('#params').append(myoptions1+myopt+myoptions_end+dbarrow+myoptions2+myopt+myoptions_end);		
			
			// select the PARA1 and PARAM2 in the two dropdowns
			$('#options1').val(PARAM1);
			$('#options2').val(PARAM2);
			
			// Add AREA config values to the config TAB fields
			$('#areax').val(AREAX);
			$('#areay').val(AREAY);
			$('#colors_approach').val(COLORS_APPROACH);
	
			// Count here the max number of elements for each value and get the max one
			max1 = 0;max1name = '';
			distinc1 = distinc(DATA, PARAM1);
			$.each(distinc1, function(i, el) {
				if (countValues(DATA, PARAM1, el) > max1) {
					max1 = countValues(DATA, PARAM1, el);
					max1name = el;
				}
			});
			
			//////////////////////////////////////////
			// DISPLAY
			
			///////////////////////
			// BLOCK REPRESENTATION

			function block_builder(DATA, blockx, blocky, param_val1, param2colors, FILTER, areaSVG) {
				var dim_node = Math.sqrt(max1);
				if (dim_node != Math.floor(dim_node)) {
					dim_node = Math.floor(dim_node)+1;
				}
				var nodex = Math.floor(blockx/dim_node);
				var nodey = Math.floor(blocky/dim_node);
					
				// creating a d3 canvas per block
				areaSVG = d3.select('#b-'+param_val1)
					.append("svg:svg")
					.attr("width", blockx)
					.attr("height", blocky)
					.style('position','relative');
				
				var my_x = 0;
				var my_y = 0;
				var count = 0;
				$.each(DATA, function(index, value) {
					var content = "<ul>";
					if(value[PARAM1] == param_val1) {
						n = count/dim_node;
						if (typeof n === 'number' && n % 1 == 0) {
							my_x = 0;
						} else {
							my_x = my_x + nodex;
						}
						// build node content:
						var mycolor; var darkme = 0;
						$.each(value, function(i, el) {
							content += "<li>"+i+" -> "+el+"</li>";
							// FIXME Filter: check browser compatibility !!
							mycolor = param2colors[value[PARAM2]];
							if (FILTER.length > 2 && String(el).indexOf(FILTER)>=0) {darkme = 1;}
							console.log("EL:"+String(el)+" | filter: "+FILTER+" | mycolor: "+mycolor);
						});
						if (darkme == 1) {mycolor = get_dark_color(mycolor);}
						content += "</ul>";
						my_y = Math.floor(n) * nodey;
						draw_node(my_x, my_y, nodex, nodey, value.id, content, mycolor, FILTER, areaSVG);
						count ++;
						content = "";
					}
				});
			}
			
			function draw_node(x, y, nodex, nodey, id, content, color, FILTER, areaSVG) {	
				areaSVG.append("svg:rect")
					.attr("x", x)
					.attr("y", y)
					.attr("width", nodex)
					.attr("height", nodey)
					.attr("stroke", "#ffffff")
					.attr('class','node')
					.attr("id", id)
					.style('fill',color)
					.on('mouseover', function(d,i) { 
			    		d3.select(this)
			      			.style('fill','lightblue'); 
			   		})
					.on('mouseout', function(d,i) { 
	        			d3.select(this)
	    					.style('fill',color); 
	      			})
	      			.on('click', function(d,i) {
		      			d3.select(this)
	  	    			//alert(content);
	  	    			$('#node_info').html(content);
	      		});
			};
			
			///////////////////////
			// MATRIX REPRESENTATION

			// Prepare colors for PARAM2 values:
			var param2colors = [];
			
			// FIXME this parameter can be added to the configuration
			// Order of blocks by PARAM1: use .sort() OR .reverse()
			var distinc2 = distinc(DATA, PARAM2).sort(); // ASC
			//var distinc2 = distinc(DATA, PARAM2).reverse(); // DESC (to use it just uncomment this line and let the sort() one active
			
			switch(COLORS_APPROACH) {
				case "random":
					colors = get_random_colors(distinc2.length);
				  break;
				case "gradient":
					colors = get_random_hsv(60, 100, distinc2.length);
				  break;
				default:
					// Approach 1: fix and sorted list of colors
					var colors = ['#CC5151', '#51CCCC', '#8ECC51', '#8E51CC', '#CCAD51', '#51CC70', '#5170CC', '#CC51AD', '#CC7F51', '#BCCC51', '#60CC51', '#51CC9E', '#519ECC', '#6051CC', '#BC51CC', '#CC517F', '#CC6851', '#CC9651', ];
					//var colors_dark = ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ];			  
				  break;
			}

			// Getting legend of param2
			var legend2 = "";
			$.each(distinc2, function(i, el) {
				param2colors[el] = colors[i];
				legend2 += '<span class="legendtxt" style="background-color:'+colors[i]+';">'+el+'</span>&nbsp;';
			});
			// Adding legend of param2
			$('#legend2').append(legend2);

			// sort DATA
			sortJSON(DATA,PARAM2);

			// FIXME this parameter can be added to the configuration
			// Order of blocks by PARAM1: use .sort() OR .reverse()
			distinc1 = distinc(DATA, PARAM1).sort(); // ASC
			//distinc1 = distinc(DATA, PARAM1).reverse(); // DESC (to use it just uncomment this line and let the sort() one active

			// Calculate size of blocks:
			// Number of blocks: distinc1.length
			var dim_blocks = Math.sqrt(distinc1.length);
			if (dim_blocks != Math.floor(dim_blocks)) {
				dim_blocks = Math.floor(dim_blocks)+1;
			}
			var blockx = Math.floor(AREAX/dim_blocks);
			var blocky = Math.floor(AREAY/dim_blocks);
			
			$('#area').css("width", AREAX+2+(2*dim_blocks)+"px"); // FIXME check this width correction
			var legend1 = ""; 
			$.each(distinc1, function(i, param1_val) {
				// Getting legent of param1
				legend1 += '<span class="legendtxt">'+param1_val+'</span>&nbsp;';
				$('#area').append('<div id="b-'+param1_val+'" class="block"><div class="blockname">'+param1_val+'</div></div>');
				block_builder(DATA, blockx, blocky, param1_val, param2colors, FILTER);
			});
			// Adding legend of param1
			$('#legend1').append(legend1);
		}
		FILTER = "";
		do_area(PARAM1, PARAM2, AREAX, AREAY, COLORS_APPROACH, FILTER);
		
		$(".submit_params").on("click", function(event){
			p1 = $("#options1").val();
			p2 = $("#options2").val();
			ax = parseInt($('#areax').val());
			ay = parseInt($('#areay').val());
			c_a = $("#colors_approach option:selected").val();
			fltr = $("#filter").val();
			
			if (p1 != 'select' || p2 != 'select') {
				prepare_divs();
				do_area(p1, p2, ax, ay, c_a, fltr);
			}
		});

		$('#tab3').on('mouseenter', function(){
		    $(this).css("z-index", 10).animate({ margin: 10, height: "+=240"});
		})
		.on('mouseleave', function(){
		    $(this).css("z-index", 0).animate({ margin: 0, height: "-=240"});
		})

    </script>
  </body>
</html>

